<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ГРИНАТОМ | Рапорт</title>
        <link rel="stylesheet" href="styles1.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Левая панель -->
    <div class="left-panel">
        <div class="panel-header">
            <div class="panel-logo">
                <div class="logo-icon">RA</div>
                <div class="logo-text">ГРИНАТОМ</div>
            </div>
            <div class="logo-subtext">РОСАТОМ</div>
        </div>
        
        <div class="user-section">
            <div class="user-name">
                <i class="fas fa-user-circle"></i>
                <span id="currentUser">Иван Иванов</span>
            </div>
        </div>
        
        <div class="nav-menu">
            <div class="nav-item active" onclick="showMainPage()">
                <div class="nav-icon"><i class="fas fa-home"></i></div>
                <span>Главная страница</span>
            </div>
            <div class="nav-item" onclick="showReports()">
                <div class="nav-icon"><i class="fas fa-file-alt"></i></div>
                <span>Рапорты</span>
            </div>
            <div class="nav-item" onclick="showDocuments()">
                <div class="nav-icon"><i class="fas fa-chart-bar"></i></div>
                <span>Отчеты</span>
            </div>
        </div>
        
        <div class="logout-section">
            <div class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Выйти</span>
            </div>
        </div>
    </div>

    <!-- Основной контейнер -->
    <div class="main-container">
        <div class="header">
            <div class="date-section">
                <div class="date-display" id="dateDisplay">Загрузка даты...</div>
                <button class="btn btn-save no-print" id="saveBtn">
                    <i class="fas fa-save"></i> Сохранить
                </button>
            </div>
            <button class="btn btn-end-shift no-print" id="endShiftBtn">
                <i class="fas fa-flag-checkered"></i> Завершить смену
            </button>
        </div>
        
        <div class="divider"></div>
        
        <div class="report-title">
            <span id="reportTitle">Загрузка...</span>
            <div class="controls no-print">
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomOutBtn">-</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" id="zoomInBtn">+</button>
                </div>
                <button class="btn btn-print" id="printBtn">
                    <i class="fas fa-print"></i> Печать
                </button>
            </div>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
        
        <div class="report-content" id="reportContent">
            <div class="report-table-container">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th width="70%">Наименование отчетной позиции</th>
                            <th width="30%">1-я смена «7:00–15:00»</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Здание 1 -->
                        <tr class="building-header">
                            <td colspan="2">Здание 1</td>
                        </tr>
                        
                        <tr id="row1">
                            <td>
                                <span class="row-number">1</span>
                                Количество принятых и переработанных методом аммиачного осаждения растворов
                                <div class="sub-description">за смену / за месяц, м³</div>
                            </td>
                            <td>
                                <button class="add-field-btn" onclick="toggleFieldOptions('row1')">+</button>
                                <div class="field-options-container" id="options-row1">
                                    <select class="field-select" onchange="handleFieldSelection('row1', this.value)">
                                        <option value="">------------------</option>
                                        <option value="manual">Ввести вручную</option>
                                    </select>
                                    <div class="new-field-container" id="new-field-row1">
                                        <input type="text" class="new-field-input" id="input-row1" placeholder="Введите название нового поля">
                                        <select class="unit-select" id="unit-row1">
                                            <option value="м³">м³</option>
                                            <option value="кг">кг</option>
                                            <option value="шт">шт</option>
                                            <option value="л">л</option>
                                            <option value="т">т</option>
                                        </select>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        
                        <tr id="row2">
                            <td>
                                <span class="row-number">2</span>
                                Количество прокаленной пульпы
                                <div class="sub-description">за смену / за месяц, м³</div>
                            </td>
                            <td>
                                <button class="add-field-btn" onclick="toggleFieldOptions('row2')">+</button>
                                <div class="field-options-container" id="options-row2">
                                    <select class="field-select" onchange="handleFieldSelection('row2', this.value)">
                                        <option value="">------------------</option>
                                        <option value="manual">Ввести вручную</option>
                                    </select>
                                    <div class="new-field-container" id="new-field-row2">
                                        <input type="text" class="new-field-input" id="input-row2" placeholder="Введите название нового поля">
                                        <select class="unit-select" id="unit-row2">
                                            <option value="м³">м³</option>
                                            <option value="кг">кг</option>
                                            <option value="шт">шт</option>
                                            <option value="л">л</option>
                                            <option value="т">т</option>
                                        </select>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        
                        <tr><td colspan="2"><div class="separator-line"></div></td></tr>
                        
                        <!-- Здание 2 -->
                        <tr class="building-header">
                            <td colspan="2">Здание 2</td>
                        </tr>
                        
                        <tr id="row3">
                            <td>
                                <span class="row-number">3</span>
                                Количество принятых и переработанных методом известкования растворов за смену / за месяц, м³
                            </td>
                            <td>
                                <button class="add-field-btn" onclick="toggleFieldOptions('row3')">+</button>
                                <div class="field-options-container" id="options-row3">
                                    <select class="field-select" onchange="handleFieldSelection('row3', this.value)">
                                        <option value="">------------------</option>
                                        <option value="manual">Ввести вручную</option>
                                    </select>
                                    <div class="new-field-container" id="new-field-row3">
                                        <input type="text" class="new-field-input" id="input-row3" placeholder="Введите название нового поля">
                                        <select class="unit-select" id="unit-row3">
                                            <option value="м³">м³</option>
                                            <option value="кг">кг</option>
                                            <option value="шт">шт</option>
                                            <option value="л">л</option>
                                            <option value="т">т</option>
                                        </select>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        
                        <tr id="row4">
                            <td>
                                <span class="row-number">4</span>
                                Отфильтровано пульпы за смену / за месяц, м³
                            </td>
                            <td>
                                <button class="add-field-btn" onclick="toggleFieldOptions('row4')">+</button>
                                <div class="field-options-container" id="options-row4">
                                    <select class="field-select" onchange="handleFieldSelection('row4', this.value)">
                                        <option value="">------------------</option>
                                        <option value="manual">Ввести вручную</option>
                                    </select>
                                    <div class="new-field-container" id="new-field-row4">
                                        <input type="text" class="new-field-input" id="input-row4" placeholder="Введите название нового поля">
                                        <select class="unit-select" id="unit-row4">
                                            <option value="м³">м³</option>
                                            <option value="кг">кг</option>
                                            <option value="шт">шт</option>
                                            <option value="л">л</option>
                                            <option value="т">т</option>
                                        </select>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        
                        <tr id="row5">
                            <td>
                                <span class="row-number">5</span>
                                Получено контейнеров, за смену / за месяц, шт.
                            </td>
                            <td>
                                <button class="add-field-btn" onclick="toggleFieldOptions('row5')">+</button>
                                <div class="field-options-container" id="options-row5">
                                    <select class="field-select" onchange="handleFieldSelection('row5', this.value)">
                                        <option value="">------------------</option>
                                        <option value="manual">Ввести вручную</option>
                                    </select>
                                    <div class="new-field-container" id="new-field-row5">
                                        <input type="text" class="new-field-input" id="input-row5" placeholder="Введите название нового поля">
                                        <select class="unit-select" id="unit-row5">
                                            <option value="м³">м³</option>
                                            <option value="кг">кг</option>
                                            <option value="шт">шт</option>
                                            <option value="л">л</option>
                                            <option value="т">т</option>
                                        </select>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        
                        <tr><td colspan="2"><div class="separator-line"></div></td></tr>
                        
                        <!-- Здание 3 -->
                        <tr class="building-header">
                            <td colspan="2">Здание 3</td>
                        </tr>
                        
                        <tr id="row6">
                            <td>
                                <span class="row-number">6</span>
                                Сжигание отходов
                                <div class="sub-description">— переработано отходов за смену / за кампанию, кг</div>
                            </td>
                            <td>
                                <button class="add-field-btn" onclick="toggleFieldOptions('row6')">+</button>
                                <div class="field-options-container" id="options-row6">
                                    <select class="field-select" onchange="handleFieldSelection('row6', this.value)">
                                        <option value="">------------------</option>
                                        <option value="manual">Ввести вручную</option>
                                    </select>
                                    <div class="new-field-container" id="new-field-row6">
                                        <input type="text" class="new-field-input" id="input-row6" placeholder="Введите название нового поля">
                                        <select class="unit-select" id="unit-row6">
                                            <option value="м³">м³</option>
                                            <option value="кг">кг</option>
                                            <option value="шт">шт</option>
                                            <option value="л">л</option>
                                            <option value="т">т</option>
                                        </select>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Элементы DOM
        const dateDisplay = document.getElementById('dateDisplay');
        const saveBtn = document.getElementById('saveBtn');
        const endShiftBtn = document.getElementById('endShiftBtn');
        const reportTitle = document.getElementById('reportTitle');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomLevel = document.getElementById('zoomLevel');
        const printBtn = document.getElementById('printBtn');
        const reportContent = document.getElementById('reportContent');
        const statusMessage = document.getElementById('statusMessage');
        
        // Элементы для данных отчета
        const currentUser = document.getElementById('currentUser');
        
        // Текущая дата из системы компьютера
        let currentDate = new Date();
        
        // Форматирование даты
        function formatDate(date) {
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('ru-RU', options);
        }
        
        // Форматирование даты для ключа в localStorage
        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Обновление отображения даты
        function updateDateDisplay() {
            const formattedDate = formatDate(currentDate);
            dateDisplay.textContent = formattedDate;
            reportTitle.textContent = `Рапорт за ${formattedDate}`;
        }
        
        // Получение текущей даты из системы
        function getCurrentSystemDate() {
            return new Date();
        }
        
        // Сохранение отчета
        function saveDate() {
            updateDateDisplay();
            
            // Сбор данных отчета
            const reportData = collectReportData();
            const dateKey = formatDateKey(currentDate);
            localStorage.setItem(`report_${dateKey}`, JSON.stringify(reportData));
            
            // Показываем сообщение об успехе
            statusMessage.textContent = `Отчет за ${formatDate(currentDate)} сохранен!`;
            statusMessage.className = 'status-message success-message';
            statusMessage.style.display = 'block';
            
            // Скрываем сообщение через 3 секунды
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
            
            console.log('Отчет сохранен:', reportData);
        }
        
        // Сбор данных отчета
        function collectReportData() {
            const reportData = {
                date: formatDateKey(currentDate),
                timestamp: new Date().toISOString(),
                operator: currentUser.textContent,
                fields: {}
            };
            
            // Собираем данные из всех полей
            for (let i = 1; i <= 6; i++) {
                const input = document.getElementById(`input-row${i}`);
                const unit = document.getElementById(`unit-row${i}`);
                const options = document.getElementById(`options-row${i}`);
                
                if (input && unit && options.style.display !== 'none') {
                    reportData.fields[`row${i}`] = {
                        name: input.value,
                        unit: unit.value
                    };
                }
            }
            
            return reportData;
        }
        
        // Завершение смены
        function endShift() {
            if (confirm('Вы уверены, что хотите завершить смену? После завершения редактирование будет невозможно.')) {
                // Сохраняем отчет перед завершением
                saveDate();
                
                statusMessage.textContent = 'Смена завершена успешно! Отчет отправлен в архив.';
                statusMessage.className = 'status-message success-message';
                statusMessage.style.display = 'block';
                
                // Блокируем все элементы редактирования
                document.querySelectorAll('.add-field-btn').forEach(btn => {
                    btn.disabled = true;
                });
                document.querySelectorAll('.field-select').forEach(select => {
                    select.disabled = true;
                });
                document.querySelectorAll('.new-field-input').forEach(input => {
                    input.disabled = true;
                });
                document.querySelectorAll('.unit-select').forEach(select => {
                    select.disabled = true;
                });
                saveBtn.disabled = true;
                endShiftBtn.disabled = true;
                
                console.log('Смена завершена');
                
                // Скрываем сообщение через 3 секунды
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 3000);
            }
        }
        
        // Управление масштабом
        let currentZoom = 100;
        
        function updateZoom() {
            zoomLevel.textContent = `${currentZoom}%`;
            reportContent.style.transform = `scale(${currentZoom / 100})`;
            reportContent.style.transformOrigin = 'top left';
        }
        
        function zoomIn() {
            if (currentZoom < 150) {
                currentZoom += 10;
                updateZoom();
            }
        }
        
        function zoomOut() {
            if (currentZoom > 50) {
                currentZoom -= 10;
                updateZoom();
            }
        }
        
        // Печать
        function printReport() {
            window.print();
        }
        
        // Функции для работы с полями ввода
        let activeRow = null;
        
        function toggleFieldOptions(rowId) {
            const row = document.getElementById(rowId);
            const options = document.getElementById(`options-${rowId}`);
            const addButton = row.querySelector('.add-field-btn');
            
            // Закрываем предыдущую открытую строку
            if (activeRow && activeRow !== rowId) {
                const prevOptions = document.getElementById(`options-${activeRow}`);
                const prevRow = document.getElementById(activeRow);
                const prevButton = prevRow.querySelector('.add-field-btn');
                
                if (prevOptions) {
                    prevOptions.style.display = 'none';
                    prevRow.style.height = 'auto';
                    prevButton.textContent = '+';
                }
            }
            
            // Открываем/закрываем текущую строку
            if (options.style.display === 'block') {
                options.style.display = 'none';
                row.style.height = 'auto';
                addButton.textContent = '+';
                activeRow = null;
            } else {
                options.style.display = 'block';
                row.style.height = 'auto';
                addButton.textContent = '−';
                activeRow = rowId;
            }
        }
        
        function handleFieldSelection(rowId, value) {
            const newFieldContainer = document.getElementById(`new-field-${rowId}`);
            
            if (value === 'manual') {
                newFieldContainer.style.display = 'block';
                // Фокусируемся на поле ввода
                setTimeout(() => {
                    document.getElementById(`input-${rowId}`).focus();
                }, 100);
            } else {
                newFieldContainer.style.display = 'none';
                // Очищаем поле ввода если выбрано другое значение
                document.getElementById(`input-${rowId}`).value = '';
            }
        }
        
        // Инициализация
        function init() {
            // Установка имени пользователя
            const username = localStorage.getItem('username') || 'Иван Иванов';
            currentUser.textContent = username;
            
            // Устанавливаем текущую дату из системы
            currentDate = getCurrentSystemDate();
            updateDateDisplay();
            
            // Загрузка сохраненного отчета
            loadSavedReport();
            
            // Обработчики событий
            saveBtn.addEventListener('click', saveDate);
            endShiftBtn.addEventListener('click', endShift);
            zoomInBtn.addEventListener('click', zoomIn);
            zoomOutBtn.addEventListener('click', zoomOut);
            printBtn.addEventListener('click', printReport);
            
            // Обработка горячих клавиш
            document.addEventListener('keydown', (e) => {
                // Ctrl + S для сохранения
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveDate();
                }
                
                // Ctrl + P для печати
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    printReport();
                }
                
                // Ctrl + '+' для увеличения масштаба
                if (e.ctrlKey && (e.key === '+' || e.key === '=')) {
                    e.preventDefault();
                    zoomIn();
                }
                
                // Ctrl + '-' для уменьшения масштаба
                if (e.ctrlKey && e.key === '-') {
                    e.preventDefault();
                    zoomOut();
                }
                
                // ESC для закрытия открытой строки
                if (e.key === 'Escape' && activeRow) {
                    const options = document.getElementById(`options-${activeRow}`);
                    const row = document.getElementById(activeRow);
                    const addButton = row.querySelector('.add-field-btn');
                    
                    if (options) {
                        options.style.display = 'none';
                        row.style.height = 'auto';
                        addButton.textContent = '+';
                        activeRow = null;
                    }
                }
            });
        }
        
        // Загрузка сохраненного отчета
        function loadSavedReport() {
            const dateKey = formatDateKey(currentDate);
            const savedReport = localStorage.getItem(`report_${dateKey}`);
            
            if (savedReport) {
                try {
                    const reportData = JSON.parse(savedReport);
                    
                    // Восстанавливаем поля если они были сохранены
                    if (reportData.fields) {
                        for (const rowId in reportData.fields) {
                            const fieldData = reportData.fields[rowId];
                            const input = document.getElementById(`input-${rowId}`);
                            const unit = document.getElementById(`unit-${rowId}`);
                            const options = document.getElementById(`options-${rowId}`);
                            const newFieldContainer = document.getElementById(`new-field-${rowId}`);
                            const select = options.querySelector('.field-select');
                            
                            if (input && unit && fieldData.name) {
                                input.value = fieldData.name;
                                unit.value = fieldData.unit || 'м³';
                                select.value = 'manual';
                                newFieldContainer.style.display = 'block';
                                // Автоматически открываем строку с сохраненными данными
                                toggleFieldOptions(rowId);
                            }
                        }
                    }
                    
                    console.log('Отчет загружен:', dateKey);
                } catch (e) {
                    console.error('Ошибка загрузки отчета:', e);
                }
            }
        }
        
        // Выход из системы
        function logout() {
            localStorage.removeItem('username');
            window.location.href = 'index.html';
        }
        
        // Навигация
        function showMainPage() {
            alert('Вы находитесь на главной странице');
        }
        
        function showReports() {
            alert('Раздел "Рапорты" находится в разработке');
        }
        
        function showDocuments() {
            alert('Раздел "Отчеты" находится в разработке');
        }
        
        // Запуск при загрузке страницы
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>